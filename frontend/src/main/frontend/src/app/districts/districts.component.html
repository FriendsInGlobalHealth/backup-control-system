<!--
@author damasceno.lopes
@email damasceno.lopes@fgh.org.mz
-->

<br>
<h5 class="light">{{ total }} {{ "districtsfound" | translate }}</h5>

<form materialize [formGroup]="form1">
  <div class="row">
    <div class="input-field col s12 m4 l4">
      <input id="name" type="text" class="validate" formControlName="name" (keyup)="search1()">
      <label for="name">
        {{ 'searchbyname' | translate }}
      </label>
    </div>
    <br/>
    <div class="col s12 m4 l4">
      <input type="checkbox" class="filled-in" id="canceled_d" formControlName="canceled" (change)="search1()" />
      <label for="canceled_d">{{ "canceled" | translate }}</label>
    </div>
  </div>
</form>

<div class="col s12 card">
  <div class="progress {{isHidden}}">
    <div class="indeterminate"></div>
  </div>
  <table class="bordered responsive-table highlight">
    <thead>
      <tr>
        <th>{{ "district" | translate }}</th>
        <th>{{ "lastbackupreceived" | translate }}</th>
        <th>{{ "lastbackuprestored" | translate }}</th>
        <th>{{ "lastsync" | translate }}</th>
        <th>{{ "districtsironkeys" | translate }}</th>
        <th>{{ "updatedon" | translate }}</th>
        <th>{{ "actions" | translate }}</th>
      </tr>
    </thead>
    <tbody>
      <tr style="line-height: 15px;" *ngFor="let district of districts | paginate: { id: 'server', itemsPerPage: 10, currentPage: p, totalItems: total }">
        <td>{{ district.name }}</td>
        <td>
          <a (click)="setSend(district.send_id_rec)" (click)="basicModal4.open()" class="waves-effect waves-teal ">
            <span class="orange-text text-darken-3">
              {{ district.last_backup_received }}
            </span>
          </a>
        </td>
        <td>
          <a (click)="setSend(district.send_id_res)" (click)="basicModal4.open()" class="waves-effect waves-teal ">
            <span class="orange-text text-darken-3">
              {{ district.last_backup_restored }}
            </span>
          </a>
        </td>
        <td>
            <a (click)="setSSync(district.sync_id)" (click)="basicModal42.open()" class="waves-effect waves-teal ">
                <span class="orange-text text-darken-3">
          {{ district.server }}</span>
        </a><br><span *ngIf="district.server" style="font-size: 13px;color:rgb(121, 120, 120);">{{ district.start_time }}-{{ district.end_time }}</span></td>
        <td>{{ district.ironkeysnumber }}</td>
        <td>{{ district.date_updated | date: 'dd/MM/yyyy' }}</td>
        <td>
          <a mz-tooltip [tooltip]="'Detalhes'" [position]="'top'" [html]="false" [delay]="100" (click)="setDistrict(district.uuid)"
            (click)="basicModal2.open()" [routerLink]="">
            <i class="material-icons icon-green">info</i>
          </a>
          &nbsp;
          <a mz-tooltip [tooltip]="'Histórico de Envio de Backup'" [position]="'top'" [html]="false" [delay]="100" (click)="setDistrict(district.uuid)"
            (click)="basicModal5.open()" (click)="getHistory(district.district_id)" [routerLink]="">
            <i class="material-icons icon-green">view_list</i>
          </a>
          &nbsp;
          <a mz-tooltip [tooltip]="'Histórico de Sincronização'" [position]="'top'" [html]="false" [delay]="100" (click)="setDistrict(district.uuid)"
            (click)="basicModal2.open()" [routerLink]="">
            <i class="material-icons icon-green">sync</i>
          </a>
          &nbsp;
          <a mz-tooltip [tooltip]="'AQD OpenMRS'" [position]="'top'" [html]="false" [delay]="100" (click)="setDistrict(district.uuid)"
            (click)="clean()" (click)="basicModal3.open()" (click)="getEvaluations()" [routerLink]="">
            <i class="material-icons icon-green">assessment</i>
          </a>
          &nbsp;
          <a mz-tooltip [tooltip]="'Editar'" [position]="'top'" [html]="false" [delay]="100" [routerLink]="['/districts', district.uuid]"
            *ngIf="ROLE_SIS">
            <i class="material-icons icon-orange">mode_edit</i>
          </a>
          &nbsp;
          <a mz-tooltip [tooltip]="'Excluir'" [position]="'top'" [html]="false" [delay]="100" (click)="setDistrict(district.uuid)"
            (click)="basicModal.open()" routerLink="/districts" *ngIf="ROLE_SIS">
            <i class="material-icons icon-red">delete</i>
          </a>
        </td>
      </tr>
    </tbody>
  </table>
</div>
<pagination-controls *ngIf="ROLE_SIS||ROLE_IT||ROLE_OA||ROLE_GMA" autoHide="true" previousLabel="" nextLabel="" (pageChange)="getPageAll($event)"
  id="server" class="right-align"></pagination-controls>
<pagination-controls *ngIf="ROLE_ODMA||ROLE_ORMA||ROLE_GDD" autoHide="true" previousLabel="" nextLabel="" (pageChange)="getPageFiltered($event)"
  id="server" class="right-align"></pagination-controls>

<mz-modal #basicModal>
  <mz-modal-header>
    <i mz-icon [align]="'left'" [icon]="'warning'" [size]="'small'">
    </i>
    <h4>{{ "confirm" | translate }}</h4>
  </mz-modal-header>
  <mz-modal-content>
    {{ "districtdelete" | translate }}: {{district.name}} ? {{ "confirmdelete" | translate }}
  </mz-modal-content>
  <mz-modal-footer>
    <button mz-button [flat]="true" (click)="deleteDistrict()" mz-modal-close>{{ "yes" | translate }}</button>
    <button mz-button [flat]="true" mz-modal-close>{{ "no" | translate }}</button>
  </mz-modal-footer>
</mz-modal>

<mz-modal #basicModal5 [fixedFooter]="true">
  <mz-modal-header>
    <h4>{{ "historysends" | translate }}</h4>
  </mz-modal-header>
  <mz-modal-content>
    <h5 class="light" *ngIf="isHidden3m=='hide'">{{ totalHistory }} {{ "sendsfound" | translate }}</h5>
    <form materialize [formGroup]="form">
      <div class="row" style="margin-top: -25px">
        <div class="input-field col s6 l3 m3" *ngIf="translate.currentLang=='pt'">
          <mz-datepicker-container>
            <input mz-datepicker [label]="'Backup de:'" [options]="options" formControlName="backup_from" type="date" (change)="search2()"
            />
          </mz-datepicker-container>
        </div>
        <div class="input-field col s6 l3 m3" *ngIf="translate.currentLang=='en'">
          <mz-datepicker-container>
            <input mz-datepicker [label]="'Backup from:'" [options]="options" formControlName="backup_from" type="date" (change)="search2()"
            />
          </mz-datepicker-container>
        </div>
        <div class="input-field col s6 l3 m3" *ngIf="translate.currentLang=='pt'">
          <mz-datepicker-container>
            <input mz-datepicker [label]="'até:'" [options]="options" formControlName="backup_until" type="date" (change)="search2()"
            />
          </mz-datepicker-container>
        </div>
        <div class="input-field col s6 l3 m3" *ngIf="translate.currentLang=='en'">
          <mz-datepicker-container>
            <input mz-datepicker [label]="'Until:'" [options]="options" formControlName="backup_until" type="date" (change)="search2()"
            />
          </mz-datepicker-container>
        </div>
        <br/>
        <br/>
        <div class="col s12 l4 m4">
          <input type="checkbox" class="filled-in" id="receiveds" formControlName="received" (change)="search2()" />
          <label for="receiveds">{{ "hisreceived" | translate }}</label>
        </div>
      </div>
    </form>

    <div class="col s12 card">
      <div class="progress {{isHidden3m}}">
        <div class="indeterminate"></div>
      </div>
      <table class="bordered responsive-table highlight">
        <thead>
          <tr>
            <th>{{ "district" | translate }}</th>
            <th>{{ "backup_date" | translate }}</th>
            <th>{{ "received" | translate }}</th>
            <th>{{ "actions" | translate }}</th>
          </tr>
        </thead>
        <tbody *ngIf="isHidden3m=='hide'&&received==false">
          <tr *ngFor="let send of sendsHistory | paginate: { id: 'serverHistory', itemsPerPage: 10, currentPage: pHistory, totalItems: totalHistory }">
            <td>{{ send.district.name }}</td>
            <td>{{ send.backup_date | date: 'dd/MM/yyyy'}}</td>
            <td *ngIf="send.received">
              {{ "yes" | translate }}
            </td>
            <td *ngIf="!send.received">
              <span style="color:red;">{{ "no" | translate }}</span>
            </td>
            <td>
              <a mz-tooltip [tooltip]="'Detalhes'" [position]="'top'" [html]="false" [delay]="100" (click)="setSend(send.send_id)" (click)="basicModal4.open()"
                [routerLink]="">
                <i class="material-icons icon-green">info</i>
              </a>
            </td>
          </tr>
        </tbody>
        <tbody *ngIf="isHidden3m=='hide'&&received==true">
          <tr *ngFor="let receive of sendsHistory | paginate: { id: 'serverHistory', itemsPerPage: 10, currentPage: pHistory, totalItems: totalHistory }">
            <td>{{ receive.send.district.name }}</td>
            <td>{{ receive.send.backup_date | date: 'dd/MM/yyyy'}}</td>
            <td *ngIf="receive.send.received">
              {{ "yes" | translate }}
            </td>
            <td>
              <a mz-tooltip [tooltip]="'Detalhes'" [position]="'top'" [html]="false" [delay]="100" (click)="setSend(receive.send.send_id)"
                (click)="basicModal4.open()" [routerLink]="">
                <i class="material-icons icon-green">info</i>
              </a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <pagination-controls *ngIf="received==false" autoHide="true" previousLabel="" nextLabel="" (pageChange)="getPageSend($event)"
      id="serverHistory" class="right-align"></pagination-controls>
    <pagination-controls *ngIf="received==true" autoHide="true" previousLabel="" nextLabel="" (pageChange)="getPageReceive($event)"
      id="serverHistory" class="right-align"></pagination-controls>
  </mz-modal-content>
  <mz-modal-footer>
    <button mz-button [flat]="true" mz-modal-close>{{ "close" | translate }}</button>
  </mz-modal-footer>
</mz-modal>

<mz-modal #basicModal2 [fixedFooter]="true">
  <mz-modal-header>
    <h4>{{ "districtdetails" | translate }}</h4>
  </mz-modal-header>
  <mz-modal-content>
    <div class="row" style="margin-top: -11px;">
      <div class="col s12">
        <h5 class="light">{{district.province}} / {{district.name}}</h5>
      </div>
    </div>
    <div class="row" style="margin-top: -11px;" *ngIf="district.ironkeysnumber">
      <div class="col s12 l2 m2"></div>
      <div class="col s12 l10 m10">{{ "districtsironkeys" | translate }}({{district.ironkeysnumber}}):
        <table class="bordered responsive-table highlight">
          <thead>
            <tr>
              <th>{{ "serialn" | translate }}</th>
              <th>{{ "capacity" | translate }}</th>
              <th>{{ "state" | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let ironkey of district.ironkeysDistrict">
              <td>
                <a (click)="basicModal2.close()" [routerLink]="['/ironkeys', ironkey.uuid]" class="waves-effect waves-teal">
                  <span class="orange-text text-darken-3">{{ ironkey.serial }}</span>
                </a>
              </td>
              <td>{{ ironkey.size }} GB</td>
              <td>{{ ironkey.status }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="row" style="margin-top: -11px;">
      <div class="col s12 l2 m2">{{ "createdby" | translate }}:</div>
      <div class="col s12 l10 m10">{{district.created_by.person.others_names}} {{district.created_by.person.surname}} - {{district.date_created | date:'dd/MM/yyyy HH:mm'}}</div>
    </div>
    <div class="row" *ngIf="district.updated_by!=null" style="margin-top: -11px;">
      <div class="col s12 l2 m2">{{ "updatedby" | translate }}:</div>
      <div class="col s12 l10 m10">{{district.updated_by.person.others_names}} {{district.updated_by.person.surname}} - {{district.date_updated | date:'dd/MM/yyyy HH:mm'}}</div>
    </div>
    <div class="row" style="margin-top: -11px;">
      <div class="col s12 l2 m2"></div>
      <div class="col s12 l10 m10">
        <span style="color:lightgrey;">{{district.uuid}}</span>
      </div>
    </div>
  </mz-modal-content>
  <mz-modal-footer>
    <button mz-button [flat]="true" mz-modal-close>{{ "close" | translate }}</button>
  </mz-modal-footer>
</mz-modal>

<mz-modal #basicModal3 [fixedFooter]="true" [fullscreen]="true">
  <mz-modal-header>
    <h4>{{ "districtdqa" | translate }}
    </h4>
  </mz-modal-header>
  <mz-modal-content>
    <div class="row">
      <div class="col s12">
        <h5 class="light">{{district.province}} / {{district.name}}</h5>
      </div>
    </div>

    <div class="row" *ngIf="district.instance_url!=null&&district.instance_username!=null&&district.instance_password!=null">
      <div class="col s11 l11 m11">
        <mz-select-container *ngIf="translate.currentLang=='pt'">
          <select mz-select [label]="'Avaliação da Qualidade de Dados'" [disabled]="isDisabled" (change)="evaluate()" [(ngModel)]="evaluation"
            [placeholder]="'Seleccione a Avaliação'" [disabled]="disabled1">
            <option *ngFor="let evaluation of evaluations" [ngValue]="evaluation">{{ evaluation.name }}</option>
          </select>
        </mz-select-container>
        <mz-select-container *ngIf="translate.currentLang=='en'">
          <select mz-select [label]="'Data Quality Evaluation'" [disabled]="isDisabled" (change)="evaluate()" [(ngModel)]="evaluation"
            [placeholder]="'Select the Evaluation'" [disabled]="disabled1">
            <option *ngFor="let evaluation of evaluations" [ngValue]="evaluation">{{ evaluation.name }}</option>
          </select>
        </mz-select-container>
      </div>
      <br>
      <div class="col s1 l1 m1" *ngIf="disabled1==true||isHidden2==''">
        <div class="preloader-wrapper small active">
          <div class="spinner-layer spinner-red-only">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top: -11px;">
      <div class="col s12" *ngIf="showResult">
        {{resultEvaluation.length}} {{ "recordsfound" | translate }}
        <br/>
        <pagination-controls autoHide=true previousLabel="" nextLabel="" (pageChange)="p2 = $event" id="d" class="pagination"></pagination-controls>
        <div class="card">
          <table class="bordered">
            <thead>
              <tr>
                <th *ngFor=" let key of keys">
                  {{key}}
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor=" let res of resultEvaluation | paginate: { itemsPerPage: 10, currentPage: p2, id: 'd' }">
                <td *ngFor=" let key of keys">
                  {{res[key]}}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <pagination-controls autoHide=true previousLabel="" nextLabel="" (pageChange)="p2 = $event" id="d" class="pagination"></pagination-controls>
      </div>
    </div>
    <div class="fixed-action-btn" style="bottom: 107px; right: 53px;">
      <a class="btn-floating tooltipped btn-small waves-effect waves-light orange {{isDisabledt2}}" data-position="left" data-tooltip="Baixar a lista"
        (click)="download()">
        <i class="material-icons">file_download</i>
      </a>
    </div>
  </mz-modal-content>
  <mz-modal-footer>
    <button mz-button [flat]="true" mz-modal-close>{{ "close" | translate }}</button>
  </mz-modal-footer>
</mz-modal>

<mz-modal #basicModal4 [fixedFooter]="true">
  <mz-modal-header>
    <h4>{{ "backupdetails" | translate }}</h4>
    <div class="progress {{isHidden2m}}">
      <div class="indeterminate"></div>
    </div>
  </mz-modal-header>
  <mz-modal-content *ngIf="isHidden2m=='hide'">
    <div class="row" style="margin-top: -11px;">
      <div class="col s12">
        <h5 class="light">{{send.district.province}} / {{send.district.name}}</h5>
      </div>
    </div>
    <div class="row" style="margin-top: -11px;">
      <div class="col s12 l2 m2">{{ "backup_date" | translate }}:</div>
      <div class="col s12 l10 m10">{{send.backup_date | date: 'dd/MM/yyyy'}}</div>
    </div>
    <div class="row" style="margin-top: -11px;">
      <div class="col s12 l2 m2">{{ "transporter" | translate }}:</div>
      <div class="col s12 l10 m10">{{send.transporter.name}} - {{send.transporter.phone_number}}</div>
    </div>
    <div class="row" style="margin-top: -11px;">
      <div class="col s12 l2 m2"></div>
      <div class="col s12 l10 m10">
        <input type="checkbox" id="update_finished" checked="{{send.update_finished==true?'checked':''}}" onclick="return false;"
        />
        <label for="update_finished">{{ "at" | translate }}</label>
      </div>
    </div>
    <div class="row" style="margin-top: -11px;">
      <div class="col s12 l2 m2"></div>
      <div class="col s12 l10 m10">
        <input type="checkbox" id="sync_finished" checked="{{send.sync_finished==true?'checked':''}}" onclick="return false;" />
        <label for="sync_finished">{{ "st" | translate }}</label>
      </div>
    </div>
    <div class="row" style="margin-top: -11px;">
      <div class="col s12 l2 m2"></div>
      <div class="col s12 l10 m10">
        <input type="checkbox" id="cross_dhis2_finished" checked="{{send.cross_dhis2_finished==true?'checked':''}}" onclick="return false;"
        />
        <label for="cross_dhis2_finished">{{ "dhis2" | translate }}</label>
      </div>
    </div>
    <div class="row" style="margin-top: -11px;">
      <div class="col s12 l2 m2"></div>
      <div class="col s12 l10 m10">
        <input type="checkbox" id="cross_idart_finished" checked="{{send.cross_idart_finished==true?'checked':''}}" onclick="return false;"
        />
        <label for="cross_idart_finished">{{ "idart" | translate }}</label>
      </div>
    </div>
    <div class="row" style="margin-top: -11px;">
      <div class="col s12 l2 m2"></div>
      <div class="col s12 l10 m10">
        <input type="checkbox" id="validation_finished" checked="{{send.validation_finished==true?'checked':''}}" onclick="return false;"
        />
        <label for="validation_finished">{{ "vt" | translate }}</label>
      </div>
    </div>
    <div class="row" style="margin-top: -11px;">
      <div class="col s12 l2 m2">{{ "obs_district" | translate }}:</div>
      <div class="col s12 l10 m10">{{send.observation}}</div>
    </div>
    <div class="row" style="margin-top: -11px;">
      <div class="col s12 l2 m2"></div>
      <div class="col s12 l3 m3">
        <input type="checkbox" id="received" checked="{{send.received==true?'checked':''}}" onclick="return false;" />
        <label for="received">{{ "hisreceived" | translate }}</label>
      </div>
      <div class="col s12 l7 m7" *ngIf="send.received">{{send.receivername}} - {{send.receivedate | date: 'dd/MM/yyyy'}}</div>
    </div>
    <div class="row" style="margin-top: -11px;">
      <div class="col s12 l2 m2"></div>
      <div class="col s12 l3 m3">
        <input type="checkbox" id="ik_returned" checked="{{send.ik_returned==true?'checked':''}}" onclick="return false;" />
        <label for="ik_returned">{{ "ikreturned" | translate }}</label>
      </div>
      <div class="col s12 l3 m3" *ngIf="send.ik_returned">{{send.ik_returnedto}} - {{send.ik_returneddate | date: 'dd/MM/yyyy'}}</div>
      <div class="col s12 l3 m3">
        <input type="checkbox" id="ik_receivedd" checked="{{send.ik_received==true?'checked':''}}" onclick="return false;" />
        <label for="ik_receivedd">{{ "ik_received" | translate }}</label>
      </div>
    </div>
    <div class="row" style="margin-top: -11px;">
      <div class="col s12 l2 m2"></div>
      <div class="col s12 l3 m3">
        <input type="checkbox" id="restored" checked="{{send.restored==true?'checked':''}}" onclick="return false;" />
        <label for="restored">{{ "backuprestored" | translate }}</label>
      </div>
      <div class="col s12 l7 m7" *ngIf="send.restored">{{send.restorername}} - {{send.date_restored | date: 'dd/MM/yyyy'}}</div>
    </div>
    <div class="row" style="margin-top: -11px;" *ngIf="send.sis_observation!=null">
      <div class="col s12 l2 m2">{{ "obs_his" | translate }}:</div>
      <div class="col s12 l10 m10">{{send.sis_observation}}</div>
    </div>
    <div class="row" style="margin-top: -11px;">
      <div class="col s12 l2 m2">{{ "createdby" | translate }}:</div>
      <div class="col s12 l10 m10">{{send.created_by.person.others_names}} {{send.created_by.person.surname}} - {{send.date_created | date: 'dd/MM/yyyy HH:mm'}}
      </div>
    </div>

    <div class="row" *ngIf="send.updated_by!=null" style="margin-top: -11px;">
      <div class="col s12 l2 m2">{{ "updatedby" | translate }}:</div>
      <div class="col s12 l10 m10">{{send.updated_by.person.others_names}} {{send.updated_by.person.surname}} - {{send.date_updated | date: 'dd/MM/yyyy HH:mm'}}
      </div>
    </div>
    <div class="row" style="margin-top: -11px;">
      <div class="col s12 l2 m2"></div>
      <div class="col s12 l10 m10">
        <span style="color:lightgrey;">{{send.uuid}}</span>
      </div>
    </div>
  </mz-modal-content>
  <mz-modal-footer>
    <button mz-button [flat]="true" mz-modal-close>{{ "close" | translate }}</button>
  </mz-modal-footer>
</mz-modal>

<div class="fixed-action-btn" style="bottom: 20px; right: 89px;">
  <a class="btn-floating btn-large orange">
    <i class="large material-icons">insert_chart</i>
  </a>
  <ul>
    <li>
      <a mz-tooltip [tooltip]="'Baixar Lista'" [position]="'left'" [html]="false" [delay]="100" (click)="printList()"
        class="btn-floating blue {{isDisabledt}}">
        <i class="material-icons">file_download</i>
      </a>
    </li>
  </ul>
</div>

<div class="fixed-action-btn" style="bottom: 20px; right: 20px;" *ngIf="ROLE_SIS">
  <a mz-tooltip [tooltip]="'Adicionar Distrito'" [position]="'top'" [html]="false" [delay]="100" class="btn-floating  btn-large waves-effect waves-light green"
    routerLink="/districts/new">
    <i class="material-icons">add</i>
  </a>
</div>